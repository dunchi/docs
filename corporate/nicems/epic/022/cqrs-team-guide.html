<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CQRS ë„ì»¤ í”„ë¡œì íŠ¸ íŒ€ ê°€ì´ë“œ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f4f7f6;
            color: #333;
            margin: 0;
            padding: 2rem;
        }
        .header {
            text-align: center;
            margin-bottom: 3rem;
        }
        .header h1 {
            font-size: 2.5rem;
            color: #2c3e50;
        }
        .content-container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
            padding: 2rem 3rem;
        }
        .content-container h2 {
            color: #34495e;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 0.5rem;
            margin-top: 2rem;
        }
        .content-container h3 {
            color: #4a627a;
            margin-top: 1.5rem;
        }
        .content-container p, .content-container li {
            font-size: 1.1rem;
            line-height: 1.7;
            color: #555;
        }
        .content-container ul {
            padding-left: 20px;
        }
        .content-container code {
            background-color: #e9ecef;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
        }
        .content-container pre {
            background-color: #e9ecef;
            padding: 1rem;
            border-radius: 8px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .home-link {
            display: block;
            text-align: center;
            margin-top: 2rem;
            text-decoration: none;
            color: #007bff;
            font-weight: 500;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
        }
        th, td {
            border: 1px solid #e9ecef;
            padding: 0.75rem;
            text-align: left;
        }
        th {
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>CQRS ë„ì»¤ í”„ë¡œì íŠ¸ íŒ€ ê°€ì´ë“œ</h1>
    </header>

    <div class="content-container">
        <h2>ğŸ“– ê°œìš”</h2>
        <p>Docker, Patroni, HAProxyë¥¼ í™œìš©í•œ CQRS ì•„í‚¤í…ì²˜ í”„ë¡œì íŠ¸ì…ë‹ˆë‹¤.<br><strong>ì½ê¸°ì™€ ì“°ê¸°ë¥¼ ì™„ì „ ë¶„ë¦¬</strong>í•˜ì—¬ ì„±ëŠ¥ê³¼ ê°€ìš©ì„±ì„ í–¥ìƒì‹œí‚µë‹ˆë‹¤.</p>

        <h2>ğŸ—ï¸ ì•„í‚¤í…ì²˜</h2>
        <pre><code>Write Network (ì“°ê¸°ìš©)           Read Network (ì½ê¸°ìš©)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ etcd + patroni1,2   â”‚ â”€â”€â”€â”€â”€â”€â†’ â”‚ postgres-read1,2,3  â”‚
â”‚ (Master-Slave)      â”‚ ë³µì œ    â”‚ (ì½ê¸° ì „ìš©)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â†‘                              â†‘
          â”‚                              â”‚
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚           HAProxy                  â”‚
      â”‚ Write: 15000  Read: 15001         â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
        <p><strong>í•µì‹¬ ì›ë¦¬</strong>:</p>
        <ul>
            <li><strong>Command(ì“°ê¸°)</strong>: 15000í¬íŠ¸ â†’ Master-Slave DB</li>
            <li><strong>Query(ì½ê¸°)</strong>: 15001í¬íŠ¸ â†’ 3ê°œ ì½ê¸° ì „ìš© DB</li>
            <li><strong>ë³µì œ</strong>: ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¬ë°ìœ¼ë¡œ ë°ì´í„° ë™ê¸°í™”</li>
            <li><strong>í˜ì¼ì˜¤ë²„</strong>: Master ì¥ì• ì‹œ Slave ìë™ ìŠ¹ê²©</li>
        </ul>

        <h2>ğŸš€ ë¹ ë¥¸ ì‹œì‘</h2>
        <h3>1. ì„¤ì¹˜</h3>
        <pre><code>git clone https://github.com/nicemso/temp-cqrs.git
cd temp-cqrs

# Patroni ì´ë¯¸ì§€ ë¹Œë“œ (ìµœì´ˆ 1íšŒë§Œ)
git clone https://github.com/patroni/patroni.git
cd patroni && docker build -t patroni:4.0.6 . && cd ..

# ì „ì²´ ì‹œìŠ¤í…œ ì‹œì‘
docker compose up -d</code></pre>

        <h3>2. ìƒíƒœ í™•ì¸</h3>
        <pre><code># ì„œë¹„ìŠ¤ ìƒíƒœ
docker compose ps

# í´ëŸ¬ìŠ¤í„° ìƒíƒœ
curl http://localhost:8008/cluster

# ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ
open http://localhost:18080/stats</code></pre>

        <h2>ğŸ§ª í…ŒìŠ¤íŠ¸</h2>
        <h3>CQRS ë™ì‘ í™•ì¸</h3>
        <pre><code># 1. ì“°ê¸° í…ŒìŠ¤íŠ¸ (Command)
psql -h localhost -p 15000 -U postgres -c "
  CREATE TABLE test (id SERIAL, message TEXT);
  INSERT INTO test (message) VALUES ('Hello CQRS');
"

# 2. ì½ê¸° í…ŒìŠ¤íŠ¸ (Query) 
psql -h localhost -p 15001 -U postgres -c "
  SELECT * FROM test;
"

# 3. ì½ê¸° DB ì“°ê¸° ì°¨ë‹¨ í™•ì¸
psql -h localhost -p 15001 -U postgres -c "
  INSERT INTO test (message) VALUES ('Should fail');
"
# ê²°ê³¼: ERROR: cannot execute INSERT in a read-only transaction</code></pre>

        <h3>ìë™í™” í…ŒìŠ¤íŠ¸</h3>
        <pre><code>cd test-application
python3 test_haproxy.py              # ì „ì²´ í…ŒìŠ¤íŠ¸
python3 test_haproxy.py --interactive # ëŒ€í™”í˜• í…ŒìŠ¤íŠ¸</code></pre>

        <h2>ğŸ”§ ìš´ì˜ ê°€ì´ë“œ</h2>
        <h3>ëª¨ë‹ˆí„°ë§</h3>
        <ul>
            <li><strong>HAProxy Stats</strong>: http://localhost:18080/stats</li>
            <li><strong>ë³µì œ ìƒíƒœ</strong>: <code>SELECT * FROM pg_stat_replication;</code> (Write DBì—ì„œ)</li>
            <li><strong>ì„œë¹„ìŠ¤ ë¡œê·¸</strong>: <code>docker compose logs -f</code></li>
        </ul>

        <h3>í˜ì¼ì˜¤ë²„ í…ŒìŠ¤íŠ¸</h3>
        <pre><code># Master ì¤‘ì§€ â†’ ìë™ í˜ì¼ì˜¤ë²„ í™•ì¸
docker stop patroni1
curl http://localhost:8009/master  # 200 ì‘ë‹µìœ¼ë¡œ ë³€ê²½ë˜ì–´ì•¼ í•¨

# ë³µêµ¬
docker start patroni1</code></pre>

        <h3>Read DB í™•ì¥</h3>
        <pre><code># docker-compose.ymlì— ì¶”ê°€
postgres-read4:
  image: postgres:16
  # ... ê¸°ì¡´ read1ê³¼ ë™ì¼í•œ ì„¤ì •
  ports:
    - "5443:5432"</code></pre>

        <h2>ğŸ¯ í•µì‹¬ í¬ì¸íŠ¸</h2>
        <h3>ì¥ì </h3>
        <ul>
            <li><strong>ì„±ëŠ¥</strong>: ì½ê¸° ë¶€í•˜ ë¶„ì‚°ìœ¼ë¡œ ì‘ë‹µì†ë„ í–¥ìƒ</li>
            <li><strong>ê°€ìš©ì„±</strong>: ìë™ í˜ì¼ì˜¤ë²„ë¡œ ë¬´ì¤‘ë‹¨ ì„œë¹„ìŠ¤</li>
            <li><strong>í™•ì¥ì„±</strong>: Read DB ì¶”ê°€ë¡œ ì½ê¸° ì„±ëŠ¥ ìŠ¤ì¼€ì¼ë§</li>
        </ul>

        <h3>ì£¼ì˜ì‚¬í•­</h3>
        <ul>
            <li><strong>ë³µì œ ì§€ì—°</strong>: ìˆ˜ ë°€ë¦¬ì´ˆ ì§€ì—° ê°€ëŠ¥ (ì¼ë°˜ì ìœ¼ë¡œ ë¬´ì‹œ ê°€ëŠ¥)</li>
            <li><strong>ì½ê¸° ì „ìš©</strong>: Read DBì—ì„œ ì“°ê¸° ì‹œë„ì‹œ ì˜¤ë¥˜ ë°œìƒ</li>
            <li><strong>ì—°ê²° ë¶„ë¦¬</strong>: ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ìš©ë„ë³„ í¬íŠ¸ êµ¬ë¶„ í•„ìˆ˜</li>
        </ul>

        <h3>í¬íŠ¸ ì •ë¦¬</h3>
        <table>
            <thead>
                <tr>
                    <th>ìš©ë„</th>
                    <th>í¬íŠ¸</th>
                    <th>ì„¤ëª…</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Write</td>
                    <td>15000</td>
                    <td>ëª¨ë“  ì“°ê¸° ì‘ì—… (INSERT, UPDATE, DELETE)</td>
                </tr>
                <tr>
                    <td>Read</td>
                    <td>15001</td>
                    <td>ëª¨ë“  ì½ê¸° ì‘ì—… (SELECT)</td>
                </tr>
                <tr>
                    <td>Stats</td>
                    <td>18080</td>
                    <td>HAProxy ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ</td>
                </tr>
                <tr>
                    <td>Direct</td>
                    <td>5432-5442</td>
                    <td>ê°œë³„ DB ì§ì ‘ ì ‘ê·¼ (ë””ë²„ê¹…ìš©)</td>
                </tr>
            </tbody>
        </table>

        <hr>
        <p><strong>ğŸ“š ì°¸ê³  ìë£Œ</strong>:</p>
        <ul>
            <li><a href="https://docs.microsoft.com/en-us/azure/architecture/patterns/cqrs" target="_blank">CQRS íŒ¨í„´</a></li>
            <li><a href="https://patroni.readthedocs.io/" target="_blank">Patroni ë¬¸ì„œ</a></li>
            <li><a href="https://www.postgresql.org/docs/current/high-availability.html" target="_blank">PostgreSQL ë³µì œ</a></li>
        </ul>

        <a href="../index.html" class="home-link">&larr; ì´ì „ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    </div>
</body>
</html>